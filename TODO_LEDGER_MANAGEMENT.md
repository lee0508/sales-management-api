# 장부 관리 기능 개발 예약

## 개요
매출/매입 발생 시 자동으로 미수금/미지급금 장부에 반영하는 기능

---

## 1. 매출 장부 관리 (미수금 관리)

### 📋 현재 상태
- ✅ 거래명세서 작성 시 자재입출내역에 출고 데이터 저장
- ❌ 미수금 자동 발생 기능 없음
- ❌ 매출처별 미수금 장부 조회 없음

### 🎯 개발 예정 기능

#### A. 거래명세서 작성 시 미수금 자동 발생
**트리거 시점**: 거래명세서 저장 시 (POST/PUT `/api/transactions`)

**영향 테이블**:
```
거래명세서 작성
    ↓
자재입출내역 (현재 구현됨)
    ↓
미수금원장 업데이트 (TODO)
    - 최종미수금일자 업데이트

미수금원장마감 업데이트 (TODO - 월별 집계)
    - 해당 월의 미수금누계금액 증가
```

**로직**:
```javascript
// server.js POST /api/transactions 수정 필요
// 거래명세서 저장 후

// 1. 매출 총액 계산
const 매출총액 = details.reduce((sum, d) => {
  const 공급가액 = d.수량 * d.단가;
  const 부가세 = Math.round(공급가액 * 0.1);
  return sum + 공급가액 + 부가세;
}, 0);

// 2. 미수금원장 업데이트 (최종미수금일자)
await pool.request()
  .input('사업장코드', sql.VarChar(2), '01')
  .input('매출처코드', sql.VarChar(8), 매출처코드)
  .input('최종미수금일자', sql.VarChar(8), 거래일자)
  .input('수정일자', sql.VarChar(8), 거래일자)
  .input('사용자코드', sql.VarChar(4), 사용자코드)
  .query(`
    -- 미수금원장이 없으면 INSERT, 있으면 UPDATE
    IF EXISTS (SELECT 1 FROM 미수금원장
               WHERE 사업장코드 = @사업장코드 AND 매출처코드 = @매출처코드)
    BEGIN
      UPDATE 미수금원장
      SET 최종미수금일자 = @최종미수금일자,
          수정일자 = @수정일자,
          사용자코드 = @사용자코드
      WHERE 사업장코드 = @사업장코드 AND 매출처코드 = @매출처코드
    END
    ELSE
    BEGIN
      INSERT INTO 미수금원장 (사업장코드, 매출처코드, 최종미수금일자, 최종입금일자, 수정일자, 사용자코드)
      VALUES (@사업장코드, @매출처코드, @최종미수금일자, '', @수정일자, @사용자코드)
    END
  `);

// 3. 미수금원장마감 업데이트 (월별 누계)
const 마감년월 = 거래일자.substring(0, 6); // YYYYMM

await pool.request()
  .input('사업장코드', sql.VarChar(2), '01')
  .input('매출처코드', sql.VarChar(8), 매출처코드)
  .input('마감년월', sql.VarChar(6), 마감년월)
  .input('매출총액', sql.Money, 매출총액)
  .input('수정일자', sql.VarChar(8), 거래일자)
  .input('사용자코드', sql.VarChar(4), 사용자코드)
  .query(`
    -- 미수금원장마감이 없으면 INSERT, 있으면 UPDATE
    IF EXISTS (SELECT 1 FROM 미수금원장마감
               WHERE 사업장코드 = @사업장코드
                 AND 매출처코드 = @매출처코드
                 AND 마감년월 = @마감년월)
    BEGIN
      UPDATE 미수금원장마감
      SET 미수금누계금액 = 미수금누계금액 + @매출총액,
          수정일자 = @수정일자,
          사용자코드 = @사용자코드
      WHERE 사업장코드 = @사업장코드
        AND 매출처코드 = @매출처코드
        AND 마감년월 = @마감년월
    END
    ELSE
    BEGIN
      INSERT INTO 미수금원장마감
        (사업장코드, 매출처코드, 마감년월, 미수금누계금액, 미수금입금누계금액, 수정일자, 사용자코드)
      VALUES
        (@사업장코드, @매출처코드, @마감년월, @매출총액, 0, @수정일자, @사용자코드)
    END
  `);
```

#### B. 매출처별 미수금 장부 조회
**화면**: 매출관리 > 매출처장부관리 (신규)

**기능**:
- 매출처 선택
- 기간별 미수금 발생/입금 내역
- 미수금 잔액 표시

**API**:
```javascript
// GET /api/customer-ledger/:customerCode
// 매출처별 미수금 현황 조회
app.get('/api/customer-ledger/:customerCode', async (req, res) => {
  // 1. 미수금 발생액 (자재입출내역에서 집계)
  // 2. 미수금 입금액 (미수금내역에서 집계)
  // 3. 미수금 잔액 계산
  // 4. 거래 내역 목록
});
```

#### C. 미수금 입금 처리
**화면**: 매출관리 > 미수금 입금 처리 (신규)

**기능**:
- 매출처 선택
- 입금액, 입금일자, 결제방법 입력
- 미수금내역 테이블에 INSERT
- 미수금원장 업데이트 (최종입금일자)
- 미수금원장마감 업데이트 (미수금입금누계금액)

---

## 2. 매입 장부 관리 (미지급금 관리)

### 📋 현재 상태
- ✅ 매입전표 작성 시 자재입출내역에 입고 데이터 저장
- ✅ 미지급금내역에 자동 생성 (이미 구현됨!)
  - 참고: [server.js:3585-3680](server.js#L3585-L3680)
  - 매입전표 작성 시 미지급금내역 자동 INSERT

### 🎯 개발 예정 기능

#### A. 매입처별 미지급금 장부 조회
**화면**: 매입관리 > 매입처장부관리 (신규)

**기능**:
- 매입처 선택
- 기간별 미지급금 발생/지급 내역
- 미지급금 잔액 표시

**API**:
```javascript
// GET /api/supplier-ledger/:supplierCode
// 매입처별 미지급금 현황 조회
app.get('/api/supplier-ledger/:supplierCode', async (req, res) => {
  // 1. 미지급금 발생액 (미지급금내역에서 집계)
  // 2. 미지급금 잔액 계산
  // 3. 거래 내역 목록
});
```

#### B. 미지급금 지급 처리
**기능**: 미지급금내역의 기존 레코드 업데이트 또는 상계 처리

---

## 3. 개발 우선순위

### Phase 1: 매출 장부 자동화
1. 거래명세서 작성 시 미수금원장 자동 업데이트
2. 미수금원장마감 월별 집계 자동화

### Phase 2: 조회 화면 개발
1. 매출처장부관리 화면
2. 매입처장부관리 화면

### Phase 3: 입금/지급 처리
1. 미수금 입금 처리 기능
2. 미지급금 지급 처리 기능

---

## 4. 참고 사항

### 테이블 구조

**미수금원장**:
- 사업장코드, 매출처코드
- 최종미수금일자, 최종입금일자
- 수정일자, 사용자코드

**미수금내역**:
- 사업장코드, 매출처코드
- 미수금입금일자, 미수금입금시간, 미수금입금금액
- 결제방법, 만기일자, 어음번호, 적요
- 수정일자, 사용자코드

**미수금원장마감**:
- 사업장코드, 매출처코드, 마감년월
- 미수금누계금액, 미수금입금누계금액
- 수정일자, 사용자코드

**미지급금내역** (CLAUDE.md 참조):
- 사업장코드, 매입처코드
- 미지급금지급일자, 미지급금지급시간, 미지급금지급금액
- 결제방법, 만기일자, 어음번호, 적요
- 수정일자, 사용자코드

### 현재 구현된 로직 위치

- 매입전표 작성 → 미지급금내역 자동 생성: [server.js:3585-3680](server.js#L3585-L3680)
- 거래명세서 작성: [server.js:3209-3334](server.js#L3209-L3334)
- 거래명세서 수정: [server.js:3104-3205](server.js#L3104-L3205)

---

## 5. 구현 시 주의사항

1. **트랜잭션 처리**: 여러 테이블 업데이트 시 실패 롤백 필요
2. **동시성 제어**: 같은 매출처/매입처에 대한 동시 처리 고려
3. **데이터 일관성**: 거래명세서 수정/삭제 시 장부도 함께 수정
4. **월마감 처리**: 익월 초 자동 마감 프로세스 필요 여부 확인

---

**작성일**: 2025-10-31
**우선순위**: Medium (현재는 자재입출내역 기반 실시간 집계로 운영 가능)
**예상 개발 기간**: Phase 1-3 합계 약 2-3주
