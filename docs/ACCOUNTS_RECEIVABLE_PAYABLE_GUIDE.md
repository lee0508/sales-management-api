# 채권/채무 관리 시스템 가이드

## 개요

판매관리 시스템의 채권(미수금)/채무(미지급금) 관리 시스템에 대한 종합 가이드입니다.

**작성일**: 2025-11-23

---

## 📊 테이블 구조

### 1. 미지급금 관리 (Accounts Payable)

#### 1.1 미지급금내역 테이블

**목적**: 매입처에 대한 지급 내역 기록

| 필드명 | 타입 | 설명 |
|--------|------|------|
| 사업장코드 | VARCHAR(2) | 사업장 구분 |
| 매입처코드 | VARCHAR(8) | 공급업체 코드 |
| 미지급금지급일자 | VARCHAR(8) | 지급일자 (YYYYMMDD) |
| 미지급금지급시간 | VARCHAR(9) | 지급시간 |
| 미지급금지급금액 | MONEY | 지급금액 (부가세 포함) |
| 결제방법 | TINYINT | 0=현금, 1=수표, 2=어음, 3=기타 |
| 만기일자 | VARCHAR(8) | 어음 만기일 (어음인 경우) |
| 어음번호 | VARCHAR(20) | 어음번호 |
| 적요 | VARCHAR(50) | 비고 (매입전표 참조번호 등) |
| 수정일자 | VARCHAR(8) | 최종 수정일 |
| 사용자코드 | VARCHAR(4) | 작업자 코드 |

**특징**:
- 매입전표 작성 시 자동 생성 ✅
- 지급일자 기준으로 누적 관리
- 결제방법별 구분 가능

#### 1.2 미지급금원장 테이블

**목적**: 매입처별 최종 미지급금 일자 관리 (현재 미사용)

| 필드명 | 타입 | 설명 |
|--------|------|------|
| 사업장코드 | VARCHAR(2) | 사업장 구분 |
| 매입처코드 | VARCHAR(8) | 공급업체 코드 |
| 최종미지급금일자 | VARCHAR(8) | 최종 미지급금 발생일 |
| 최종지급일자 | VARCHAR(8) | 최종 지급일 |
| 수정일자 | VARCHAR(8) | 최종 수정일 |
| 사용자코드 | VARCHAR(4) | 작업자 코드 |

#### 1.3 미지급금원장마감 테이블

**목적**: 월별 미지급금 누계 관리 (마감 집계)

| 필드명 | 타입 | 설명 |
|--------|------|------|
| 사업장코드 | VARCHAR(2) | 사업장 구분 |
| 매입처코드 | VARCHAR(8) | 공급업체 코드 |
| 마감년월 | VARCHAR(6) | 마감년월 (YYYYMM) |
| 미지급금누계금액 | MONEY | 해당 월 미지급금 누계 |
| 미지급금지급누계금액 | MONEY | 해당 월 지급 누계 |
| 수정일자 | VARCHAR(8) | 최종 수정일 |
| 사용자코드 | VARCHAR(4) | 작업자 코드 |

**용도**:
- 월별 장부 마감
- 연간 미지급금 추이 분석
- 매입처별 거래 통계

---

### 2. 미수금 관리 (Accounts Receivable)

#### 2.1 미수금내역 테이블

**목적**: 매출처에 대한 입금 내역 기록

| 필드명 | 타입 | 설명 |
|--------|------|------|
| 사업장코드 | VARCHAR(2) | 사업장 구분 |
| 매출처코드 | VARCHAR(8) | 고객 코드 |
| 미수금입금일자 | VARCHAR(8) | 입금일자 (YYYYMMDD) |
| 미수금입금시간 | VARCHAR(9) | 입금시간 |
| 미수금입금금액 | MONEY | 입금금액 (부가세 포함) |
| 결제방법 | TINYINT | 0=현금, 1=수표, 2=어음, 3=기타 |
| 만기일자 | VARCHAR(8) | 어음 만기일 (어음인 경우) |
| 어음번호 | VARCHAR(20) | 어음번호 |
| 적요 | VARCHAR(50) | 비고 (거래명세서 참조번호 등) |
| 수정일자 | VARCHAR(8) | 최종 수정일 |
| 사용자코드 | VARCHAR(4) | 작업자 코드 |

**⚠️ 중요 - 필드명 주의**:
- 필드명이 `미수금입금일자`, `미수금입금금액`이지만
- 거래명세서 작성 시점에 **미수금 발생**을 기록하는 용도로도 사용
- 실제 입금 시에는 회계담당자가 별도로 입금 처리

**특징**:
- 거래명세서 작성 시 자동 생성 ✅ (2025-11-23 구현)
- 입금일자 기준으로 누적 관리
- 결제방법별 구분 가능

#### 2.2 미수금원장 테이블

**목적**: 매출처별 최종 미수금 일자 관리 (현재 미사용)

| 필드명 | 타입 | 설명 |
|--------|------|------|
| 사업장코드 | VARCHAR(2) | 사업장 구분 |
| 매출처코드 | VARCHAR(8) | 고객 코드 |
| 최종미수금일자 | VARCHAR(8) | 최종 미수금 발생일 |
| 최종입금일자 | VARCHAR(8) | 최종 입금일 |
| 수정일자 | VARCHAR(8) | 최종 수정일 |
| 사용자코드 | VARCHAR(4) | 작업자 코드 |

#### 2.3 미수금원장마감 테이블

**목적**: 월별 미수금 누계 관리 (마감 집계)

| 필드명 | 타입 | 설명 |
|--------|------|------|
| 사업장코드 | VARCHAR(2) | 사업장 구분 |
| 매출처코드 | VARCHAR(8) | 고객 코드 |
| 마감년월 | VARCHAR(6) | 마감년월 (YYYYMM) |
| 미수금누계금액 | MONEY | 해당 월 미수금 누계 |
| 미수금입금누계금액 | MONEY | 해당 월 입금 누계 |
| 수정일자 | VARCHAR(8) | 최종 수정일 |
| 사용자코드 | VARCHAR(4) | 작업자 코드 |

**용도**:
- 월별 장부 마감
- 연간 미수금 추이 분석
- 매출처별 거래 통계

---

## 🔄 데이터 플로우

### 매입 프로세스 (Purchase Process)

```
1. 매입전표 작성 (POST /api/purchase-statements)
   ↓
2. 자재입출내역 INSERT
   - 입출고구분 = 1 (입고)
   - 매입처코드, 입고수량, 입고단가, 입고부가
   ↓
3. 미지급금내역 자동 생성 ✅
   - 미지급금지급일자 = 거래일자
   - 미지급금지급금액 = SUM(입고수량 × 입고단가 × 1.1)
   - 적요 = "매입전표 YYYYMMDD-번호"
   ↓
4. 지급 처리 (수동 - 회계담당자)
   - 현금/수표/어음으로 실제 지급
   - 미지급금내역에 추가 INSERT 또는 UPDATE
```

**구현 위치**: [server.js:6261-6537](../server.js#L6261-L6537)

---

### 매출 프로세스 (Sales Process)

```
1. 거래명세서 작성 (POST /api/transactions)
   ↓
2. 자재입출내역 INSERT
   - 입출고구분 = 2 (출고)
   - 매출처코드, 출고수량, 출고단가, 출고부가
   ↓
3. 미수금내역 자동 생성 ✅
   - 미수금입금일자 = 거래일자
   - 미수금입금금액 = SUM(출고수량 × 출고단가 × 1.1)
   - 적요 = "거래명세서 YYYYMMDD-번호"
   ↓
4. 입금 처리 (수동 - 회계담당자)
   - 현금/수표/어음으로 실제 입금 확인
   - 미수금내역에 추가 INSERT 또는 UPDATE
```

**구현 위치**: [server.js:5210-5238](../server.js#L5210-L5238)

---

## 💡 핵심 개념

### 1. 자동 생성 vs 수동 입력

| 구분 | 자동 생성 | 수동 입력 |
|------|----------|----------|
| **미지급금** | 매입전표 작성 시 | 실제 지급 시 |
| **미수금** | 거래명세서 작성 시 | 실제 입금 시 |
| **목적** | 채무/채권 발생 기록 | 실제 결제 기록 |
| **담당** | 시스템 자동 | 회계담당자 |

### 2. 필드명의 의미

**미지급금내역**:
- `미지급금지급일자` / `미지급금지급금액`
- 의미: "아직 지급하지 않은 금액"의 지급 예정일/금액

**미수금내역**:
- `미수금입금일자` / `미수금입금금액`
- 의미: "아직 받지 못한 금액"의 입금 예정일/금액

⚠️ **주의**: 필드명이 "지급"/"입금"이지만, 자동 생성 시점에는 "예정"의 의미로 사용

### 3. 잔액 계산 로직

#### 미지급금 잔액
```sql
미지급금잔액 = 총매입액 - 총지급액

WHERE:
  총매입액 = SUM(입고수량 × 입고단가 × 1.1)
           FROM 자재입출내역
           WHERE 입출고구분 = 1 AND 사용구분 = 0

  총지급액 = SUM(미지급금지급금액)
           FROM 미지급금내역
           WHERE 매입처코드 = @매입처코드
```

#### 미수금 잔액
```sql
미수금잔액 = 총매출액 - 총입금액

WHERE:
  총매출액 = SUM(출고수량 × 출고단가 × 1.1)
           FROM 자재입출내역
           WHERE 입출고구분 = 2 AND 사용구분 = 0

  총입금액 = SUM(미수금입금금액)
           FROM 미수금내역
           WHERE 매출처코드 = @매출처코드
```

---

## 📋 Stored Procedures

### 1. sp미지급금원장인쇄

**목적**: 매입처별 미지급금 장부 조회

**매개변수**:
- `@ParAppBranchCode`: 사업장코드
- `@ParAppFDate`: 시작일자
- `@ParAppTDate`: 종료일자
- `@ParSupplierCode`: 매입처코드 (LIKE 검색)
- `@ParMJGbn`: 장부 구분 (1=자재입출내역 기준, 2=세금계산서 기준)

**반환 데이터**:
```sql
- 연/월 이월 (미지급금원장마감에서)
- 매입 발생액 (자재입출내역 또는 매입세금계산서장부에서)
- 지급 내역 (미지급금내역에서)
```

**참고 파일**: [미지급금원장인쇄sp.txt](../미지급금원장인쇄sp.txt)

---

### 2. sp미수금원장인쇄

**목적**: 매출처별 미수금 장부 조회

**매개변수**:
- `@ParAppBranchCode`: 사업장코드
- `@ParAppFDate`: 시작일자
- `@ParAppTDate`: 종료일자
- `@ParSupplierCode`: 매출처코드 (LIKE 검색)
- `@ParMSGbn`: 장부 구분 (1=자재입출내역 기준, 2=세금계산서 기준)

**반환 데이터**:
```sql
- 연/월 이월 (미수금원장마감에서)
- 매출 발생액 (자재입출내역 또는 매출세금계산서장부에서)
- 입금 내역 (미수금내역에서)
```

**참고 파일**: [미수금원장인쇄sp.txt](../미수금원장인쇄sp.txt)

---

## 🚀 API 구현 현황

### ✅ 구현 완료 (2025-11-23)

#### 미지급금 관리 API

1. **미지급금 자동 생성**
   - **API**: `POST /api/purchase-statements`
   - **위치**: [server.js:6261-6537](../server.js#L6261-L6537)
   - **기능**: 매입전표 작성 시 미지급금내역 자동 INSERT

2. **미지급금 내역 조회**
   - **API**: `GET /api/accounts-payable`
   - **위치**: [server.js:6720-6759](../server.js#L6720-L6759)
   - **기능**: 매입처별/기간별 미지급금 내역 조회
   - **Query Params**: `매입처코드`, `시작일자`, `종료일자`

3. **미지급금 지급 처리** ⭐ NEW
   - **API**: `POST /api/accounts-payable`
   - **위치**: [server.js:6761-6828](../server.js#L6761-L6828)
   - **기능**: 회계담당자가 실제 지급 시 사용
   - **Body**: `매입처코드`, `미지급금지급일자`, `미지급금지급금액`, `결제방법`, `만기일자`, `어음번호`, `적요`

4. **미지급금 잔액 조회**
   - **API**: `GET /api/accounts-payable/balance/:supplierCode`
   - **위치**: [server.js:6831-6872](../server.js#L6831-L6872)
   - **기능**: 매입처별 미지급금 잔액 계산 (총매입액 - 총지급액)

#### 미수금 관리 API

1. **미수금 자동 생성**
   - **API**: `POST /api/transactions`
   - **위치**: [server.js:5210-5238](../server.js#L5210-L5238)
   - **기능**: 거래명세서 작성 시 미수금내역 자동 INSERT

2. **미수금 내역 조회** ⭐ NEW
   - **API**: `GET /api/accounts-receivable`
   - **위치**: [server.js:6879-6919](../server.js#L6879-L6919)
   - **기능**: 매출처별/기간별 미수금 내역 조회
   - **Query Params**: `매출처코드`, `시작일자`, `종료일자`

3. **미수금 입금 처리** ⭐ NEW
   - **API**: `POST /api/accounts-receivable`
   - **위치**: [server.js:6922-6990](../server.js#L6922-L6990)
   - **기능**: 회계담당자가 실제 입금 확인 시 사용
   - **Body**: `매출처코드`, `미수금입금일자`, `미수금입금금액`, `결제방법`, `만기일자`, `어음번호`, `적요`

4. **미수금 잔액 조회** ⭐ NEW
   - **API**: `GET /api/accounts-receivable/balance/:customerCode`
   - **위치**: [server.js:6993-7041](../server.js#L6993-L7041)
   - **기능**: 매출처별 미수금 잔액 계산 (총매출액 - 총입금액)

---

### ❌ 미구현 (향후 개발 예정)

#### 1. 매입처 장부관리 화면

- **화면**: 매입처 선택 → 거래내역 + 지급내역 표시
- **기능**:
  - 매입전표 목록 (자재입출내역 기준)
  - 지급 내역 목록 (미지급금내역)
  - 잔액 계산 및 표시
  - 지급 처리 버튼 → POST /api/accounts-payable 호출

#### 2. 매출처 장부관리 화면

- **화면**: 매출처 선택 → 거래내역 + 입금내역 표시
- **기능**:
  - 거래명세서 목록 (자재입출내역 기준)
  - 입금 내역 목록 (미수금내역)
  - 잔액 계산 및 표시
  - 입금 처리 버튼 → POST /api/accounts-receivable 호출

---

## 🎯 사용 시나리오

### 시나리오 1: 매입 및 지급 처리

```
1. [영업담당자] 매입전표 작성
   → 시스템이 미지급금내역 자동 생성
   → 미지급금 발생: 1,100,000원

2. [회계담당자] 미지급금 확인
   → GET /api/accounts-payable/balance/00000001
   → 잔액: 1,100,000원

3. [회계담당자] 현금으로 500,000원 지급
   → POST /api/accounts-payable (미구현)
   → {
       지급일자: "20251201",
       지급금액: 500000,
       결제방법: 0 (현금),
       적요: "부분 지급"
     }

4. [회계담당자] 잔액 재확인
   → GET /api/accounts-payable/balance/00000001
   → 잔액: 600,000원 (1,100,000 - 500,000)
```

---

### 시나리오 2: 매출 및 입금 처리

```
1. [영업담당자] 거래명세서 작성
   → 시스템이 미수금내역 자동 생성
   → 미수금 발생: 2,200,000원

2. [회계담당자] 미수금 확인
   → GET /api/accounts-receivable/balance/00000001 (미구현)
   → 잔액: 2,200,000원

3. [회계담당자] 어음으로 2,200,000원 입금 확인
   → POST /api/accounts-receivable (미구현)
   → {
       입금일자: "20251201",
       입금금액: 2200000,
       결제방법: 2 (어음),
       만기일자: "20260101",
       어음번호: "12345678",
       적요: "전액 입금 (어음)"
     }

4. [회계담당자] 잔액 재확인
   → GET /api/accounts-receivable/balance/00000001 (미구현)
   → 잔액: 0원 (전액 입금 완료)
```

---

## 📌 개발 가이드

### 1. 미수금 입금 처리 API 구현 예시

```javascript
// POST /api/accounts-receivable
app.post('/api/accounts-receivable', async (req, res) => {
  const {
    사업장코드,
    매출처코드,
    미수금입금일자,
    미수금입금금액,
    결제방법,
    만기일자,
    어음번호,
    적요
  } = req.body;

  try {
    const pool = await sql.connect(config);

    const 미수금입금시간 = new Date().toISOString().replace(/[-:TZ.]/g, '').substring(0, 9);
    const 수정일자 = 미수금입금일자;
    const 사용자코드 = req.session?.user?.사용자코드 || '8080';

    await pool.request()
      .input('사업장코드', sql.VarChar(2), 사업장코드)
      .input('매출처코드', sql.VarChar(8), 매출처코드)
      .input('미수금입금일자', sql.VarChar(8), 미수금입금일자)
      .input('미수금입금시간', sql.VarChar(9), 미수금입금시간)
      .input('미수금입금금액', sql.Money, 미수금입금금액)
      .input('결제방법', sql.TinyInt, 결제방법)
      .input('만기일자', sql.VarChar(8), 만기일자 || '')
      .input('어음번호', sql.VarChar(20), 어음번호 || '')
      .input('적요', sql.VarChar(50), 적요 || '')
      .input('수정일자', sql.VarChar(8), 수정일자)
      .input('사용자코드', sql.VarChar(4), 사용자코드)
      .query(`
        INSERT INTO 미수금내역 (
          사업장코드, 매출처코드, 미수금입금일자, 미수금입금시간,
          미수금입금금액, 결제방법, 만기일자, 어음번호, 적요,
          수정일자, 사용자코드
        ) VALUES (
          @사업장코드, @매출처코드, @미수금입금일자, @미수금입금시간,
          @미수금입금금액, @결제방법, @만기일자, @어음번호, @적요,
          @수정일자, @사용자코드
        )
      `);

    res.json({
      success: true,
      message: '미수금 입금 처리가 완료되었습니다.',
      data: {
        미수금입금일자,
        미수금입금금액,
        결제방법
      }
    });

  } catch (err) {
    console.error('미수금 입금 처리 오류:', err);
    res.status(500).json({
      success: false,
      message: '미수금 입금 처리 중 오류가 발생했습니다.',
      error: err.message
    });
  }
});
```

---

### 2. 미수금 잔액 조회 API 구현 예시

```javascript
// GET /api/accounts-receivable/balance/:customerCode
app.get('/api/accounts-receivable/balance/:customerCode', async (req, res) => {
  const { customerCode } = req.params;
  const 사업장코드 = req.session?.user?.사업장코드 || '01';

  try {
    const pool = await sql.connect(config);

    // 1. 총매출액 계산 (자재입출내역에서)
    const salesResult = await pool.request()
      .input('사업장코드', sql.VarChar(2), 사업장코드)
      .input('매출처코드', sql.VarChar(8), customerCode)
      .query(`
        SELECT
          ISNULL(SUM((출고수량 * 출고단가) + 출고부가), 0) AS 총매출액
        FROM 자재입출내역
        WHERE 사업장코드 = @사업장코드
          AND 매출처코드 = @매출처코드
          AND 입출고구분 = 2
          AND 사용구분 = 0
      `);

    const 총매출액 = salesResult.recordset[0].총매출액;

    // 2. 총입금액 계산 (미수금내역에서)
    const receivedResult = await pool.request()
      .input('사업장코드', sql.VarChar(2), 사업장코드)
      .input('매출처코드', sql.VarChar(8), customerCode)
      .query(`
        SELECT
          ISNULL(SUM(미수금입금금액), 0) AS 총입금액
        FROM 미수금내역
        WHERE 사업장코드 = @사업장코드
          AND 매출처코드 = @매출처코드
      `);

    const 총입금액 = receivedResult.recordset[0].총입금액;

    // 3. 잔액 계산
    const 미수금잔액 = 총매출액 - 총입금액;

    res.json({
      success: true,
      data: {
        매출처코드: customerCode,
        총매출액,
        총입금액,
        미수금잔액
      }
    });

  } catch (err) {
    console.error('미수금 잔액 조회 오류:', err);
    res.status(500).json({
      success: false,
      message: '미수금 잔액 조회 중 오류가 발생했습니다.',
      error: err.message
    });
  }
});
```

---

## 🔍 트러블슈팅

### 문제 1: 미수금 자동 생성 시 필드명 오류

**증상**:
```
Invalid column name '미수금발생일자'
```

**원인**:
- 테이블 필드명이 `미수금입금일자`인데 `미수금발생일자` 사용

**해결**:
- 필드명을 `미수금입금일자`, `미수금입금금액`으로 수정
- [server.js:5216-5218](../server.js#L5216-L5218) 참조

---

### 문제 2: 결제방법 데이터 타입 불일치

**증상**:
```
Error converting data type varchar to tinyint
```

**원인**:
- `결제방법` 필드는 TINYINT 타입인데 VARCHAR로 입력

**해결**:
```javascript
// ❌ 잘못된 코드
.input('결제방법', sql.VarChar(10), '')

// ✅ 올바른 코드
.input('결제방법', sql.TinyInt, 0) // 0=현금
```

---

## 📚 참고 자료

### 관련 파일
- [CLAUDE.md](../CLAUDE.md) - 프로젝트 전체 가이드
- [server.js](../server.js) - API 구현 코드
- [미지급금내역_table.txt](../미지급금내역_table.txt) - 테이블 스키마
- [미수금내역_table.txt](../미수금내역_table.txt) - 테이블 스키마
- [미지급금원장인쇄sp.txt](../미지급금원장인쇄sp.txt) - Stored Procedure
- [미수금원장인쇄sp.txt](../미수금원장인쇄sp.txt) - Stored Procedure

### API 엔드포인트
- `POST /api/purchase-statements` - 매입전표 작성 (미지급금 자동 생성)
- `POST /api/transactions` - 거래명세서 작성 (미수금 자동 생성)
- `GET /api/accounts-payable/balance/:supplierCode` - 미지급금 잔액 조회

---

## 요약

### ✅ 구현 완료
1. 매입전표 작성 시 미지급금 자동 생성
2. 거래명세서 작성 시 미수금 자동 생성
3. 미지급금 잔액 조회 API

### ❌ 향후 개발 필요
1. 미수금/미지급금 수동 입력 API
2. 미수금 잔액 조회 API
3. 매입처/매출처 장부관리 API 및 화면
4. 월별 마감 처리 기능

### 🎯 핵심 포인트
- 자동 생성: 매입/매출 발생 시점
- 수동 입력: 실제 지급/입금 시점
- 필드명 주의: `미수금입금일자/금액`, `미지급금지급일자/금액`
- 결제방법: 0=현금, 1=수표, 2=어음, 3=기타
