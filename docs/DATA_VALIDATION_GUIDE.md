# 데이터 검증 가이드 (Data Validation Guide)

## 개요

자재입출내역 테이블의 데이터 품질을 보장하기 위해 매입전표 및 거래명세서 작성 시 필수 필드를 검증합니다.

## 검증 항목

### 1. 거래일자 검증 (필수)

**검증 규칙:**
- 형식: YYYYMMDD (8자리 숫자)
- 범위: 1900년 ~ 2100년
- NULL 및 빈값 불가

**예시:**
```javascript
// ✅ 올바른 형식
거래일자 = "20251122"

// ❌ 잘못된 형식
거래일자 = "2025-11-22"  // 하이픈 포함
거래일자 = "251122"      // 6자리
거래일자 = "29280511"    // 범위 초과 (2928년)
거래일자 = ""            // 빈값
거래일자 = null          // NULL
```

**에러 메시지:**
- `"거래일자는 YYYYMMDD 형식(8자리 숫자)이어야 합니다."`
- `"거래일자가 유효하지 않습니다. (1900년~2100년 사이여야 합니다)"`

### 2. 거래처코드 검증 (필수)

**검증 규칙:**
- 매입전표: 매입처코드 필수
- 거래명세서: 매출처코드 필수
- 빈값 및 공백만 있는 경우 불가

**예시:**
```javascript
// 매입전표
// ✅ 올바른 형식
매입처코드 = "B041"

// ❌ 잘못된 형식
매입처코드 = ""          // 빈값
매입처코드 = "   "       // 공백만
매입처코드 = null        // NULL

// 거래명세서
// ✅ 올바른 형식
매출처코드 = "C2510225"

// ❌ 잘못된 형식
매출처코드 = ""          // 빈값
```

**에러 메시지:**
- `"매입처코드는 필수입니다."`
- `"매출처코드는 필수입니다."`

### 3. 상세내역 검증 (필수)

**검증 규칙:**
- 최소 1개 이상의 품목 필요
- 각 품목별 검증:
  - 자재코드: 필수, 빈값 불가
  - 수량: 필수, 0보다 큰 값
  - 단가: 필수 (0 허용 - 나중에 수정 가능)

**예시:**
```javascript
// ✅ 올바른 형식
details = [
  { 자재코드: "0101MOFS105", 수량: 1, 단가: 620000 },
  { 자재코드: "01CODE00161", 수량: 2, 단가: 0 }  // 단가=0 허용
]

// ❌ 잘못된 형식
details = []  // 빈 배열
details = [
  { 자재코드: "", 수량: 1, 단가: 1000 }  // 자재코드 빈값
]
details = [
  { 자재코드: "0101MOFS105", 수량: 0, 단가: 1000 }  // 수량=0
]
details = [
  { 자재코드: "0101MOFS105", 수량: 1 }  // 단가 누락
]
```

**에러 메시지:**
- `"필수 정보가 누락되었습니다. (거래일자, 매입처코드, 상세내역)"`
- `"1번째 항목: 자재코드가 누락되었습니다."`
- `"2번째 항목: 수량은 0보다 커야 합니다."`
- `"3번째 항목: 단가가 누락되었습니다."`

## API 엔드포인트

### 거래명세서 작성 (POST /api/transactions)

**Request Body:**
```json
{
  "거래일자": "20251122",
  "입출고구분": 2,
  "매출처코드": "C2510225",
  "적요": "제품 출고",
  "details": [
    {
      "자재코드": "0101MOFS105",
      "수량": 1,
      "단가": 620000
    }
  ]
}
```

**검증 순서:**
1. 로그인 세션 확인
2. 거래일자 형식 및 범위 검증
3. 매출처코드 검증
4. 상세내역 개수 확인
5. 각 품목별 자재코드, 수량, 단가 검증

### 매입전표 작성 (POST /api/purchase-statements)

**Request Body:**
```json
{
  "거래일자": "20251122",
  "입출고구분": 1,
  "매입처코드": "B041",
  "적요": "자재 입고",
  "details": [
    {
      "자재코드": "0101MOFS105",
      "수량": 10,
      "단가": 50000
    }
  ]
}
```

**검증 순서:**
1. 로그인 세션 확인
2. 거래일자 형식 및 범위 검증
3. 매입처코드 검증
4. 상세내역 개수 확인
5. 각 품목별 자재코드, 수량, 단가 검증

## 자동 생성 필드

다음 필드들은 서버에서 자동으로 생성되므로 클라이언트에서 전송할 필요가 없습니다:

- **입출고일자**: 거래일자와 동일하게 자동 설정
- **입출고시간**: 현재 시각(HHMMSS + 밀리초 3자리) 자동 생성
- **거래번호**: 로그 테이블에서 자동 증가
- **사업장코드**: 세션의 사용자 사업장코드 자동 사용
- **사용자코드**: 세션의 사용자코드 자동 사용

## 단가=0 처리 정책

**중요**: 단가=0은 유효한 값으로 허용됩니다.

**이유:**
- 매입전표 발생 시 단가가 확정되지 않은 경우 0으로 등록
- 거래명세서 작성 시 단가가 미정인 경우 0으로 임시 등록
- 나중에 실제 단가가 확정되면 수정 가능

**검증 로직:**
```javascript
// ✅ 허용 - 단가=0
if (detail.단가 === null || detail.단가 === undefined) {
  return error;  // NULL/undefined만 거부
}

// ❌ 허용하지 않음 - 수량=0
if (!detail.수량 || detail.수량 <= 0) {
  return error;  // 수량은 반드시 0보다 커야 함
}
```

## 데이터 검증 스크립트

### 1. 핵심 필드 검증 (validate-core-fields.js)

필수 필드만 집중적으로 검증:
```bash
node scripts/validate-core-fields.js
```

**검증 항목:**
- 입출고일자 (NULL, 범위, 길이)
- 입출고시간 (NULL, 형식)
- 거래일자 (NULL, 범위, 길이)
- 매입처코드 (입출고구분=1일 때)
- 매출처코드 (입출고구분=2일 때)

### 2. 전체 데이터 검증 (validate-inventory-data.js)

모든 데이터 품질 검증:
```bash
node scripts/validate-inventory-data.js
```

**검증 항목:**
- 핵심 필드 검증 (위와 동일)
- 단가=0 데이터 통계 (참고용)
- 기타 이상 데이터 확인

### 3. 자동 수정 (fix-inventory-data.js)

비정상 일자 데이터 자동 수정:
```bash
node scripts/fix-inventory-data.js
```

**처리 내용:**
- 거래일자/입출고일자가 1900년 이전 또는 2100년 이후인 레코드를 `사용구분=1`로 처리
- 단가=0 데이터는 **수정하지 않음** (유효한 데이터로 간주)

## 기존 데이터 정리 결과

**전체 레코드 수**: 520,678건

### ✅ 자동 수정 완료
- 입출고일자 오류: 8건 → 0건
- 거래일자 오류: 8건 → 0건

### ✅ 문제 없음
- 입출고시간: 0건
- 매출처코드: 0건

### ⚠️ 수동 수정 필요
- 매입처코드 누락: 13건
  - 실제 거래 (수량>0, 단가>0): 2건
  - 단가=0 거래 (나중에 수정 예정): 11건

**즉시 수정 필요한 2건:**
```
거래일자: 20251109, 거래번호: 2
- 자재: 01MOFS105 (입고수량: 1, 입고단가: 620,000원)
- 자재: CODE00161 (입고수량: 1, 입고단가: 70,000원)
```

## 프론트엔드 검증

백엔드 검증과 별도로 프론트엔드에서도 사용자 경험 향상을 위해 검증을 수행할 수 있습니다:

```javascript
// 거래일자 검증
function validateDate(dateStr) {
  if (!/^\d{8}$/.test(dateStr)) {
    alert('거래일자는 YYYYMMDD 형식(8자리 숫자)이어야 합니다.');
    return false;
  }

  const year = parseInt(dateStr.substring(0, 4));
  if (year < 1900 || year > 2100) {
    alert('거래일자가 유효하지 않습니다. (1900년~2100년 사이여야 합니다)');
    return false;
  }

  return true;
}

// 거래처코드 검증
function validateSupplierCode(code) {
  if (!code || code.trim() === '') {
    alert('매입처코드는 필수입니다.');
    return false;
  }
  return true;
}

// 상세내역 검증
function validateDetails(details) {
  if (!details || details.length === 0) {
    alert('최소 1개 이상의 품목을 추가해야 합니다.');
    return false;
  }

  for (let i = 0; i < details.length; i++) {
    const detail = details[i];

    if (!detail.자재코드 || detail.자재코드.trim() === '') {
      alert(`${i + 1}번째 항목: 자재코드가 누락되었습니다.`);
      return false;
    }

    if (!detail.수량 || detail.수량 <= 0) {
      alert(`${i + 1}번째 항목: 수량은 0보다 커야 합니다.`);
      return false;
    }

    if (detail.단가 === null || detail.단가 === undefined) {
      alert(`${i + 1}번째 항목: 단가가 누락되었습니다.`);
      return false;
    }
  }

  return true;
}
```

## 요약

### 필수 검증 항목
1. ✅ 거래일자 (형식, 범위)
2. ✅ 매입처코드/매출처코드 (빈값 방지)
3. ✅ 상세내역 (자재코드, 수량, 단가)

### 허용 항목
- ✅ 단가=0 (나중에 수정 가능)

### 불가 항목
- ❌ 수량=0
- ❌ 거래일자 NULL/빈값/범위 초과
- ❌ 거래처코드 NULL/빈값

이 검증 로직을 통해 앞으로는 데이터 품질 문제가 발생하지 않습니다.
