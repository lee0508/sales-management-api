# 회계전표 수정/삭제 기능 개선 방안

> 작성일: 2025-11-21
> 상태: 검토 필요

## 현재 상태

현재 구현된 회계전표 수정/삭제 기능:
- 직접 수정 방식 (금액, 적요 필드 직접 변경)
- 소프트 삭제 (사용구분 = 1)
- 권한 체크 없음

## 개선 필요 사항

### 1. 수정 기능 → 대체전표/수정전표 방식

회계 실무에서는 원본 전표를 직접 수정하지 않고 대체전표를 발행합니다.

#### A. 대체전표 방식 (권장)
```
원본 전표 (유지, 상태='R')
    ↓
역분개 전표 자동 생성 (차변↔대변 반대)
    ↓
새로운 정정 전표 생성
```

**구현 시 필요 작업:**
1. 회계전표 테이블에 `전표상태` 필드 추가
   ```sql
   ALTER TABLE 회계전표
   ADD 전표상태 CHAR(1) DEFAULT 'N'
   -- 'N'=정상, 'C'=취소됨, 'R'=대체됨, 'M'=수정됨
   ```

2. 역분개 전표 자동 생성 SP 개발
   - 원본 전표의 차변/대변을 반대로 생성
   - 적요에 "○○전표 대체" 명시
   - 참조전표 필드로 연결 관계 표시

3. UI 변경
   - "수정" 버튼 → "대체전표 발행" 버튼으로 변경
   - 원본 전표 조회 시 연결된 대체전표 표시

#### B. 수정전표 방식 (간단)
```
원본 전표 (유지)
    ↓
차액만큼 조정 전표 생성
```

**장점:**
- 완전한 감사 추적(Audit Trail) 가능
- 누가 언제 무엇을 수정했는지 이력 보존
- 회계감사 시 투명성 확보

---

### 2. 삭제 기능 → 권한 기반 제한

#### 권한 체계 제안

| 권한코드 | 역할 | 회계전표 권한 |
|---------|------|-------------|
| 99 | 시스템 관리자 | 모든 권한 (삭제 포함) |
| 80 | 회계책임자 | 전표 삭제 가능 |
| 70 | 회계담당자 | 전표 작성/대체전표 생성만 가능 |
| 50 | 영업관리자 | 조회만 가능 |
| 30 | 일반 사용자 | 조회만 가능 |

#### 프론트엔드 구현 예시
```javascript
function deleteSelectedVouchers() {
  const userRole = sessionStorage.getItem('사용자권한');

  // 관리자(99)와 회계책임자(80)만 삭제 가능
  if (!['99', '80'].includes(userRole)) {
    alert('회계전표 삭제 권한이 없습니다.\n회계책임자에게 문의하세요.');
    return;
  }

  // ... 기존 삭제 로직
}
```

#### 백엔드 구현 예시
```javascript
app.delete('/api/accounting-vouchers/batch-delete', requireAuth, async (req, res) => {
  const userRole = req.session.user?.사용자권한;

  if (!['99', '80'].includes(userRole)) {
    return res.status(403).json({
      success: false,
      message: '회계전표 삭제 권한이 없습니다.'
    });
  }

  // ... 기존 삭제 로직
});
```

---

### 3. 추가 고려사항

#### A. 마감 후 전표 수정 방지

```javascript
// 회계 마감일 체크
async function checkClosingDate(전표일자) {
  const response = await fetch('/api/accounting/closing-date');
  const { 마감일자 } = await response.json();

  if (전표일자 <= 마감일자) {
    alert('마감된 기간의 전표는 수정할 수 없습니다.');
    return false;
  }
  return true;
}
```

#### B. 수정 이력 테이블 추가

```sql
CREATE TABLE 회계전표수정이력 (
  이력번호 INT IDENTITY(1,1) PRIMARY KEY,
  원전표번호 VARCHAR(20),
  원전표일자 VARCHAR(8),
  수정전표번호 VARCHAR(20),
  수정전표일자 VARCHAR(8),
  수정일시 VARCHAR(17),
  수정자코드 VARCHAR(4),
  수정사유 NVARCHAR(200),
  수정구분 CHAR(1)  -- 'R'=대체, 'A'=조정, 'C'=취소
);
```

#### C. 전표 상태 관리

| 상태 | 코드 | 설명 |
|-----|------|------|
| 정상 | N | 일반 전표 |
| 취소 | C | 삭제/취소된 전표 |
| 대체됨 | R | 대체전표가 발행된 원본 |
| 수정됨 | M | 수정전표가 발행된 원본 |

---

### 4. 구현 우선순위

#### Phase 1 (즉시 적용) - 예상 1일
- [ ] 삭제 권한 체크 추가 (프론트엔드 + 백엔드)
- [ ] 마감 기간 체크 추가
- [ ] 삭제 시 확인 단계 강화

#### Phase 2 (단기) - 예상 3-5일
- [ ] 회계전표 테이블에 전표상태 필드 추가
- [ ] 대체전표 생성 SP 개발
- [ ] UI에서 "수정" → "대체전표 발행"으로 변경
- [ ] 수정 이력 테이블 추가

#### Phase 3 (중장기) - 예상 1-2주
- [ ] 전표 승인 워크플로우
- [ ] 회계 마감 기능 강화
- [ ] 감사 로그 시스템
- [ ] 전표 상태별 필터링/조회 기능

---

## 참고: 관련 파일

- 프론트엔드: `index.html` (lines 18260-18724)
- 백엔드 API: `server.js` (lines 7550-7671)
- 회계전표 조회 API: `server.js` (lines 7481-7548)

## 메모

- 현재 구현은 개발/테스트 목적으로 사용
- 실제 운영 시에는 Phase 1 적용 필수
- 회계감사 대비를 위해 Phase 2까지 구현 권장
