# 장부관리 메뉴 구현 가이드

## 📋 개요

현재 "장부관리" 메뉴의 하위 항목들은 미구현 상태입니다. 이 문서는 각 메뉴의 구현에 필요한 데이터베이스 테이블 정보와 구현 방법을 정리한 가이드입니다.

**현재 상태 (2025-11-15)**:
- ✅ 메뉴 중복 정리 완료
- ❌ 미구현 메뉴에 "준비 중입니다" 알림 메시지 설정
- ✅ 현금출납관리는 "회계관리 > 현금출납내역관리"로 이동 완료

---

## 📊 미구현 메뉴 목록

### 1️⃣ 매입처장부관리 (Supplier Ledger Management)

**목적**: 매입처별 미지급금 발생 및 지급 현황 조회

#### 필요 데이터베이스 테이블

##### 주요 테이블: 미지급금내역 (❌ 생성 필요)

```sql
CREATE TABLE 미지급금내역 (
  사업장코드 VARCHAR(2) NOT NULL,
  매입처코드 VARCHAR(8) NOT NULL,
  미지급금지급일자 VARCHAR(8) NOT NULL,
  미지급금지급시간 VARCHAR(9) NOT NULL,
  미지급금지급금액 MONEY DEFAULT 0,
  결제방법 TINYINT DEFAULT 0,  -- 0:현금, 1:수표, 2:어음, 3:기타
  만기일자 VARCHAR(8) DEFAULT '',
  어음번호 VARCHAR(20) DEFAULT '',
  적요 VARCHAR(50) DEFAULT '',
  수정일자 VARCHAR(8) DEFAULT '',
  사용자코드 VARCHAR(4) DEFAULT '',
  PRIMARY KEY (사업장코드, 매입처코드, 미지급금지급일자, 미지급금지급시간)
);
```

##### 보조 테이블
- **미지급금원장마감**: 월별 집계용 (이미 존재)
- **자재입출내역**: 입출고구분=1 (매입 데이터)
- **매입처**: 공급업체 정보
- **사업장**: 사업장 정보

#### 데이터 소스

1. **매입 발생**: `자재입출내역` WHERE `입출고구분 = 1`
   ```sql
   SELECT
     사업장코드, 매입처코드, 입출고일자 AS 일자,
     SUM(입고수량 * 입고단가 * 1.1) AS 매입금액
   FROM 자재입출내역
   WHERE 입출고구분 = 1 AND 사용구분 = 0
   GROUP BY 사업장코드, 매입처코드, 입출고일자
   ```

2. **지급 내역**: `미지급금내역`
   ```sql
   SELECT
     사업장코드, 매입처코드, 미지급금지급일자 AS 일자,
     SUM(미지급금지급금액) AS 지급금액,
     결제방법, 만기일자, 어음번호
   FROM 미지급금내역
   GROUP BY 사업장코드, 매입처코드, 미지급금지급일자, 결제방법, 만기일자, 어음번호
   ```

#### 핵심 비즈니스 로직

```javascript
// 미지급금 잔액 계산
총매입액 = SUM(입고수량 × 입고단가 × 1.1) FROM 자재입출내역 WHERE 입출고구분=1
총지급액 = SUM(미지급금지급금액) FROM 미지급금내역
미지급잔액 = 총매입액 - 총지급액
```

#### 화면 구성

1. **목록 화면**: 매입처별 미지급금 잔액 요약
2. **상세 화면**: 선택한 매입처의 거래 내역 (매입 발생 + 지급 내역)
3. **필터**: 기간별, 매입처별, 잔액 여부

#### API 엔드포인트 (예정)

```javascript
GET  /api/supplier-ledger                    // 매입처별 장부 목록
GET  /api/supplier-ledger/:supplierCode      // 특정 매입처 상세
GET  /api/supplier-ledger/:supplierCode/balance  // 매입처별 잔액 조회
```

#### 참고 파일
- `미지급금원장인쇄sp.txt`: 기존 출력용 저장 프로시저 (참고용)

---

### 2️⃣ 매출처장부관리 (Customer Ledger Management)

**목적**: 매출처별 미수금 발생 및 입금 현황 조회

#### 필요 데이터베이스 테이블

##### 주요 테이블: 미수금내역 (✅ 이미 존재)

**테이블 구조**:
```sql
-- 기존 테이블 스키마 (참고용)
사업장코드 VARCHAR(2) NOT NULL
매출처코드 VARCHAR(8) NOT NULL
미수금입금일자 VARCHAR(8) NOT NULL
미수금입금시간 VARCHAR(9) NOT NULL
미수금입금금액 MONEY DEFAULT 0
결제방법 TINYINT DEFAULT 0  -- 0:현금, 1:수표, 2:어음, 3:기타
만기일자 VARCHAR(8) DEFAULT ''
어음번호 VARCHAR(20) DEFAULT ''
적요 VARCHAR(50) DEFAULT ''
수정일자 VARCHAR(8) DEFAULT ''
사용자코드 VARCHAR(4) DEFAULT ''
```

##### 보조 테이블
- **미수금원장마감**: 월별 집계용
- **자재입출내역**: 입출고구분=2 (매출 데이터)
- **매출처**: 고객 정보
- **사업장**: 사업장 정보

#### 데이터 소스

1. **매출 발생**: `자재입출내역` WHERE `입출고구분 = 2`
   ```sql
   SELECT
     사업장코드, 매출처코드, 입출고일자 AS 일자,
     SUM(출고수량 * 출고단가 * 1.1) AS 매출금액
   FROM 자재입출내역
   WHERE 입출고구분 = 2 AND 사용구분 = 0
   GROUP BY 사업장코드, 매출처코드, 입출고일자
   ```

2. **입금 내역**: `미수금내역`
   ```sql
   SELECT
     사업장코드, 매출처코드, 미수금입금일자 AS 일자,
     SUM(미수금입금금액) AS 입금금액,
     결제방법, 만기일자, 어음번호
   FROM 미수금내역
   GROUP BY 사업장코드, 매출처코드, 미수금입금일자, 결제방법, 만기일자, 어음번호
   ```

#### 핵심 비즈니스 로직

```javascript
// 미수금 잔액 계산
총매출액 = SUM(출고수량 × 출고단가 × 1.1) FROM 자재입출내역 WHERE 입출고구분=2
총입금액 = SUM(미수금입금금액) FROM 미수금내역
미수금잔액 = 총매출액 - 총입금액
```

#### 화면 구성

1. **목록 화면**: 매출처별 미수금 잔액 요약
2. **상세 화면**: 선택한 매출처의 거래 내역 (매출 발생 + 입금 내역)
3. **필터**: 기간별, 매출처별, 잔액 여부

#### API 엔드포인트 (예정)

```javascript
GET  /api/customer-ledger                    // 매출처별 장부 목록
GET  /api/customer-ledger/:customerCode      // 특정 매출처 상세
GET  /api/customer-ledger/:customerCode/balance  // 매출처별 잔액 조회
```

#### 참고 파일
- `미수금내역_table.txt`: 테이블 스키마
- `미수금원장인쇄sp.txt`: 기존 출력용 저장 프로시저

---

### 3️⃣ 미수금관리 (Accounts Receivable Management)

**목적**: 매출처별 미수금 입금 등록 및 조회

#### 필요 데이터베이스 테이블

- **미수금내역** (✅ 이미 존재)
- **매출처** (고객 정보)
- **자재입출내역** (매출 발생 내역 참조)

#### 주요 기능

1. **미수금 입금 등록**
   - 매출처 선택
   - 입금일자, 입금금액 입력
   - 결제방법 선택 (현금, 수표, 어음, 기타)
   - 어음인 경우: 만기일자, 어음번호 입력

2. **미수금 내역 조회**
   - 기간별 필터링
   - 매출처별 필터링
   - 결제방법별 필터링

3. **미수금 잔액 조회**
   - 매출처별 총 미수금
   - 매출처별 총 입금액
   - 매출처별 미수금 잔액

4. **CRUD 기능**
   - 등록: POST /api/receivables
   - 조회: GET /api/receivables
   - 수정: PUT /api/receivables/:date/:time
   - 삭제: DELETE /api/receivables/:date/:time (사용구분=9)

#### 화면 구성

**현금출납내역관리와 유사한 구조**:
- DataTable 기반 목록
- 모달 기반 등록/수정
- 체크박스 선택 시 수정/삭제 버튼 활성화
- CSV 내보내기 기능

#### API 엔드포인트 (예정)

```javascript
GET    /api/receivables                    // 미수금 내역 목록
GET    /api/receivables/:date/:time        // 특정 미수금 내역 상세
POST   /api/receivables                    // 미수금 입금 등록
PUT    /api/receivables/:date/:time        // 미수금 내역 수정
DELETE /api/receivables/:date/:time        // 미수금 내역 삭제 (사용구분=9)
GET    /api/receivables/balance/:customerCode  // 매출처별 미수금 잔액
```

#### 구현 참고
- **템플릿**: `js/cash-history.js` (현금출납내역관리)
- **테이블 구조**: 복합키 (사업장코드 + 매출처코드 + 미수금입금일자 + 미수금입금시간)
- **시간 형식**: HHMMSSMMM (9자리)

---

### 4️⃣ 미지급금관리 (Accounts Payable Management)

**목적**: 매입처별 미지급금 지급 등록 및 조회

#### 필요 데이터베이스 테이블

- **미지급금내역** (❌ 생성 필요)
- **매입처** (공급업체 정보)
- **자재입출내역** (매입 발생 내역 참조)

#### 주요 기능

1. **미지급금 지급 등록**
   - 매입처 선택
   - 지급일자, 지급금액 입력
   - 결제방법 선택 (현금, 수표, 어음, 기타)
   - 어음인 경우: 만기일자, 어음번호 입력

2. **미지급금 내역 조회**
   - 기간별 필터링
   - 매입처별 필터링
   - 결제방법별 필터링

3. **미지급금 잔액 조회**
   - 매입처별 총 미지급금
   - 매입처별 총 지급액
   - 매입처별 미지급금 잔액

4. **CRUD 기능**
   - 등록: POST /api/payables
   - 조회: GET /api/payables
   - 수정: PUT /api/payables/:date/:time
   - 삭제: DELETE /api/payables/:date/:time (사용구분=9)

#### 화면 구성

**현금출납내역관리와 유사한 구조**:
- DataTable 기반 목록
- 모달 기반 등록/수정
- 체크박스 선택 시 수정/삭제 버튼 활성화
- CSV 내보내기 기능

#### API 엔드포인트 (예정)

```javascript
GET    /api/payables                       // 미지급금 내역 목록
GET    /api/payables/:date/:time           // 특정 미지급금 내역 상세
POST   /api/payables                       // 미지급금 지급 등록
PUT    /api/payables/:date/:time           // 미지급금 내역 수정
DELETE /api/payables/:date/:time           // 미지급금 내역 삭제 (사용구분=9)
GET    /api/payables/balance/:supplierCode // 매입처별 미지급금 잔액
```

#### 기존 구현 참고

**매입전표 작성 시 자동 생성 로직** (`server.js:3585-3680`):
```javascript
// 매입전표 작성 완료 후 미지급금내역 자동 생성
const 총매입액 = details.reduce((sum, item) => {
  const 공급가액 = item.입고수량 * item.입고단가;
  const 부가세 = item.입고부가;
  return sum + 공급가액 + 부가세;
}, 0);

await pool.request()
  .input('사업장코드', sql.VarChar(2), 사업장코드)
  .input('매입처코드', sql.VarChar(8), 매입처코드)
  .input('미지급금지급일자', sql.VarChar(8), 거래일자)
  .input('미지급금지급시간', sql.VarChar(9), 작성시간)
  .input('미지급금지급금액', sql.Money, 총매입액)
  .query(`
    INSERT INTO 미지급금내역 (사업장코드, 매입처코드, 미지급금지급일자, ...)
    VALUES (@사업장코드, @매입처코드, @미지급금지급일자, ...)
  `);
```

#### 구현 참고
- **템플릿**: `js/cash-history.js` (현금출납내역관리)
- **테이블 구조**: 복합키 (사업장코드 + 매입처코드 + 미지급금지급일자 + 미지급금지급시간)
- **시간 형식**: HHMMSSMMM (9자리)

---

### 5️⃣ 세금계산서관리 (Tax Invoice Management)

**목적**: 전자세금계산서 발행 및 관리

#### 필요 데이터베이스 테이블

##### 주요 테이블: 세금계산서 (✅ 이미 존재)

**테이블 구조**:
```sql
-- 기존 테이블 스키마
사업장코드 VARCHAR(2) NOT NULL
작성년도 VARCHAR(4) NOT NULL
책번호 REAL DEFAULT 0
일련번호 REAL DEFAULT 0
매출처코드 VARCHAR(8) NOT NULL
작성일자 VARCHAR(8) NOT NULL
품목및규격 VARCHAR(50) DEFAULT ''
수량 REAL DEFAULT 0
공급가액 MONEY DEFAULT 0
세액 MONEY DEFAULT 0
금액구분 TINYINT DEFAULT 3    -- 0:현금, 1:수표, 2:어음, 3:외상
영청구분 TINYINT DEFAULT 0    -- 0:과세, 1:영세, 2:면세
발행여부 TINYINT DEFAULT 1    -- 0:미발행, 1:발행
작성구분 TINYINT DEFAULT 0    -- 0:정발행, 1:역발행
미수구분 TINYINT DEFAULT 0    -- 0:현금, 1:외상
적요 VARCHAR(50) DEFAULT ''
사용구분 TINYINT DEFAULT 0    -- 0:사용, 9:삭제
수정일자 VARCHAR(8) DEFAULT ''
사용자코드 VARCHAR(4) DEFAULT ''
```

##### 보조 테이블
- **매출세금계산서장부**: 매출 세금계산서 장부
- **매입세금계산서장부**: 매입 세금계산서 장부
- **매출처**: 고객 정보
- **자재입출내역**: 거래명세서 데이터 연동

#### 주요 기능

1. **세금계산서 발행**
   - 거래명세서 기반 자동 생성
   - 수동 입력 발행
   - 작성년도, 책번호, 일련번호 자동 채번

2. **발행 현황 조회**
   - 작성년도별
   - 책번호별
   - 발행여부별 (발행/미발행)
   - 영청구분별 (과세/영세/면세)

3. **구분 관리**
   - **금액구분**: 0=현금, 1=수표, 2=어음, 3=외상
   - **영청구분**: 0=과세, 1=영세, 2=면세
   - **발행여부**: 0=미발행, 1=발행
   - **작성구분**: 0=정발행, 1=역발행
   - **미수구분**: 0=현금, 1=외상

4. **국세청 연동** (향후 구현)
   - 전자세금계산서 발행
   - 발행내역 조회
   - 승인번호 관리

#### 화면 구성

1. **목록 화면**: 세금계산서 발행 내역
2. **등록 화면**: 신규 세금계산서 작성
3. **상세 화면**: 세금계산서 상세 정보
4. **출력 화면**: A4 용지 출력 (기존 SP 활용)

#### API 엔드포인트 (예정)

```javascript
GET    /api/tax-invoices                      // 세금계산서 목록
GET    /api/tax-invoices/:year/:book/:serial  // 특정 세금계산서 상세
POST   /api/tax-invoices                      // 세금계산서 발행
PUT    /api/tax-invoices/:year/:book/:serial  // 세금계산서 수정
DELETE /api/tax-invoices/:year/:book/:serial  // 세금계산서 삭제 (사용구분=9)
POST   /api/tax-invoices/from-transaction     // 거래명세서 기반 생성
```

#### 참고 파일
- `세금계산서_table.txt`: 테이블 스키마
- `세금계산서A4인쇄sp.txt`: A4 출력용 저장 프로시저
- `매출세금계산서현황인쇄sp.txt`: 현황 출력용 저장 프로시저

---

## 📌 테이블 생성 우선순위

### 즉시 생성 필요

#### 1. 미지급금내역 테이블

```sql
USE [YmhDB]
GO

CREATE TABLE [dbo].[미지급금내역] (
  [사업장코드] VARCHAR(2) NOT NULL DEFAULT '',
  [매입처코드] VARCHAR(8) NOT NULL DEFAULT '',
  [미지급금지급일자] VARCHAR(8) NOT NULL DEFAULT '',
  [미지급금지급시간] VARCHAR(9) NOT NULL DEFAULT '',
  [미지급금지급금액] MONEY NOT NULL DEFAULT 0,
  [결제방법] TINYINT NOT NULL DEFAULT 0,  -- 0:현금, 1:수표, 2:어음, 3:기타
  [만기일자] VARCHAR(8) NOT NULL DEFAULT '',
  [어음번호] VARCHAR(20) NOT NULL DEFAULT '',
  [적요] VARCHAR(50) NOT NULL DEFAULT '',
  [수정일자] VARCHAR(8) NOT NULL DEFAULT '',
  [사용자코드] VARCHAR(4) NOT NULL DEFAULT '',
  CONSTRAINT [PK_미지급금내역] PRIMARY KEY CLUSTERED (
    [사업장코드] ASC,
    [매입처코드] ASC,
    [미지급금지급일자] ASC,
    [미지급금지급시간] ASC
  )
)
GO
```

### 이미 존재하는 테이블

- ✅ **미수금내역**: 매출처별 미수금 입금 내역
- ✅ **세금계산서**: 세금계산서 발행 내역
- ✅ **미수금원장마감**: 미수금 월별 집계
- ✅ **미지급금원장마감**: 미지급금 월별 집계

---

## 🚀 구현 권장 순서

### Phase 1: 기본 미수/미지급금 관리
1. **미지급금내역 테이블 생성** ⭐ 최우선
2. **미수금관리 페이지 구현** (테이블 이미 존재)
3. **미지급금관리 페이지 구현** (테이블 생성 후)

### Phase 2: 장부 조회 기능
4. **매출처장부관리 페이지 구현**
5. **매입처장부관리 페이지 구현**

### Phase 3: 세금계산서 관리
6. **세금계산서관리 페이지 구현** (복잡도 높음)
7. **국세청 전자세금계산서 연동** (향후)

---

## 💡 구현 패턴 참고

### 템플릿: 현금출납내역관리

모든 장부관리 기능은 **현금출납내역관리**와 유사한 패턴으로 구현 가능:

1. **백엔드** (`server.js`):
   - GET: 목록 조회 (날짜 범위, 필터링)
   - GET: 상세 조회 (복합키)
   - POST: 신규 등록
   - PUT: 수정
   - DELETE: 삭제 (사용구분=9)

2. **프론트엔드** (`js/*.js`):
   - DataTable 기반 목록 표시
   - 모달 기반 등록/수정
   - 체크박스 선택 시 버튼 토글
   - CSV 내보내기

3. **HTML** (`index.html`):
   - 페이지 HTML: `<!-- content-area End -->` 앞
   - 모달 HTML: `</body>` 앞

### 파일 구조 예시

```
미수금관리 구현 시:
- server.js: API 엔드포인트 추가 (lines ~7100+)
- js/receivables.js: 프론트엔드 로직 (신규)
- index.html: 페이지 + 모달 HTML 추가
```

---

## 📝 주요 비즈니스 로직

### 미수금 잔액 계산

```javascript
// 매출 발생액 (자재입출내역에서 집계)
const 총매출액 = await pool.request()
  .input('사업장코드', sql.VarChar(2), 사업장코드)
  .input('매출처코드', sql.VarChar(8), 매출처코드)
  .query(`
    SELECT SUM(출고수량 * 출고단가 * 1.1) AS 총매출액
    FROM 자재입출내역
    WHERE 사업장코드 = @사업장코드
      AND 매출처코드 = @매출처코드
      AND 입출고구분 = 2
      AND 사용구분 = 0
  `);

// 입금액 (미수금내역에서 집계)
const 총입금액 = await pool.request()
  .input('사업장코드', sql.VarChar(2), 사업장코드)
  .input('매출처코드', sql.VarChar(8), 매출처코드)
  .query(`
    SELECT SUM(미수금입금금액) AS 총입금액
    FROM 미수금내역
    WHERE 사업장코드 = @사업장코드
      AND 매출처코드 = @매출처코드
  `);

// 미수금 잔액
const 미수금잔액 = 총매출액 - 총입금액;
```

### 미지급금 잔액 계산

```javascript
// 매입 발생액 (자재입출내역에서 집계)
const 총매입액 = await pool.request()
  .input('사업장코드', sql.VarChar(2), 사업장코드)
  .input('매입처코드', sql.VarChar(8), 매입처코드)
  .query(`
    SELECT SUM(입고수량 * 입고단가 * 1.1) AS 총매입액
    FROM 자재입출내역
    WHERE 사업장코드 = @사업장코드
      AND 매입처코드 = @매입처코드
      AND 입출고구분 = 1
      AND 사용구분 = 0
  `);

// 지급액 (미지급금내역에서 집계)
const 총지급액 = await pool.request()
  .input('사업장코드', sql.VarChar(2), 사업장코드)
  .input('매입처코드', sql.VarChar(8), 매입처코드)
  .query(`
    SELECT SUM(미지급금지급금액) AS 총지급액
    FROM 미지급금내역
    WHERE 사업장코드 = @사업장코드
      AND 매입처코드 = @매입처코드
  `);

// 미지급금 잔액
const 미지급금잔액 = 총매입액 - 총지급액;
```

---

## 🔍 참고 자료

### 문서 파일
- `계정과목_table.txt`: 계정과목 테이블 스키마
- `회계전표내역_table.txt`: 회계전표내역 테이블 스키마
- `미수금내역_table.txt`: 미수금내역 테이블 스키마
- `세금계산서_table.txt`: 세금계산서 테이블 스키마

### 저장 프로시저 (출력 참고용)
- `미수금원장인쇄sp.txt`: 미수금 원장 출력
- `미지급금원장인쇄sp.txt`: 미지급금 원장 출력
- `세금계산서A4인쇄sp.txt`: 세금계산서 A4 출력
- `매출세금계산서현황인쇄sp.txt`: 매출 세금계산서 현황

### 구현 코드 참고
- `server.js:3585-3680`: 매입전표 작성 시 미지급금내역 자동 생성
- `server.js:6706-7076`: 현금출납내역관리 API
- `js/cash-history.js`: 현금출납내역관리 프론트엔드
- `index.html:1680-1764`: 현금출납내역관리 페이지
- `index.html:17593-18115`: 현금출납내역관리 모달

---

## ✅ 체크리스트

### 미지급금내역 테이블 생성 후
- [ ] 테이블 생성 SQL 실행
- [ ] 테이블 구조 확인 (INFORMATION_SCHEMA.COLUMNS)
- [ ] 샘플 데이터 입력 테스트
- [ ] 기존 매입전표 작성 로직 연동 확인

### 미수금관리 구현 시
- [ ] API 엔드포인트 구현 (server.js)
- [ ] 프론트엔드 로직 구현 (js/receivables.js)
- [ ] 페이지 HTML 추가 (index.html)
- [ ] 모달 HTML 추가 (index.html)
- [ ] 메뉴 연결 (`showPage('receivables-management')`)
- [ ] 기능 테스트 (등록, 조회, 수정, 삭제)

### 미지급금관리 구현 시
- [ ] API 엔드포인트 구현 (server.js)
- [ ] 프론트엔드 로직 구현 (js/payables.js)
- [ ] 페이지 HTML 추가 (index.html)
- [ ] 모달 HTML 추가 (index.html)
- [ ] 메뉴 연결 (`showPage('payables-management')`)
- [ ] 기능 테스트 (등록, 조회, 수정, 삭제)

---

**작성일**: 2025-11-15
**작성자**: Claude Code
**버전**: 1.0
