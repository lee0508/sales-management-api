================================================================================
판매관리 시스템 배포 가이드
================================================================================

버전: Phase 1 완료
대상: 온프레미스 각 업체별 개별 설치

================================================================================
📋 시스템 요구사항
================================================================================

필수 소프트웨어:
--------------
✅ Node.js 14.x 이상
✅ MS SQL Server 2008 R2 이상
✅ Windows Server 또는 Windows 10/11

네트워크:
--------
- 포트 3000 (웹 서버)
- 포트 1433 (MS SQL Server)

================================================================================
🚀 신규 업체 설치 절차 (10단계)
================================================================================

1단계: 파일 복사
--------------
전체 프로젝트 폴더를 업체 서버에 복사

2단계: Node.js 패키지 설치
-----------------------
프로젝트 폴더에서 실행:
> npm install

3단계: 환경변수 설정
-----------------
.env.template 파일을 .env로 복사:
> copy .env.template .env

.env 파일을 메모장으로 열어서 다음 항목 수정:

[필수 수정 항목]
DB_USER=sa
DB_PASSWORD=각_업체의_고유한_비밀번호로_변경
DB_SERVER=localhost
DB_DATABASE=YmhDB

SESSION_SECRET=랜덤문자열32자이상생성하세요
JWT_SECRET=랜덤문자열32자이상생성하세요

⚠️ 주의: SESSION_SECRET은 각 업체마다 다른 값으로 설정!
         예시: kJ8mN2pQ9rS4tU7vW1xY3zA5bC6dE8fG

4단계: DB 연결 테스트
------------------
> node scripts/test-db.js

✅ 연결 성공 메시지 확인
❌ 실패 시: .env 파일의 DB 정보 재확인

5단계: 데이터베이스 스키마 업데이트
-------------------------------
SQL Server Management Studio에서 실행:

USE YmhDB;
GO

ALTER TABLE 사용자 ALTER COLUMN 로그인비밀번호 VARCHAR(100);
GO

6단계: 기존 비밀번호 해싱 (선택사항)
--------------------------------
기존 사용자가 있다면 비밀번호를 해시로 변환:

⚠️ 중요: DB 백업 먼저!

> node scripts/migrate-passwords.js

프롬프트에서 "yes" 입력하여 계속 진행

7단계: 서버 테스트 실행
--------------------
> npm start

아래 메시지 확인:
✅ SQL Server 연결 성공
✅ Server running at http://127.0.0.1:3000

8단계: 웹 브라우저 테스트
----------------------
브라우저에서 접속:
http://localhost:3000

로그인 페이지가 나타나는지 확인

9단계: 로그인 테스트
-----------------
기존 사용자 계정으로 로그인 시도
- 비밀번호 마이그레이션 했다면: 기존 평문 비밀번호 그대로 사용 가능
- 새 사용자 추가 시: hash-password.js로 해시 생성 후 DB 삽입

10단계: 서비스 등록 (선택사항)
---------------------------
Windows 서비스로 등록하여 자동 시작 설정
PM2, NSSM 등 사용 권장

================================================================================
🔧 유틸리티 스크립트 사용법
================================================================================

1. DB 연결 테스트
--------------
> node scripts/test-db.js

용도: .env 설정이 올바른지 확인

2. 비밀번호 해싱
-------------
> node scripts/hash-password.js [비밀번호]

예시:
> node scripts/hash-password.js 1234

출력된 해시값을 DB에 직접 업데이트:
UPDATE 사용자 SET 로그인비밀번호 = '$2b$10$...' WHERE 사용자코드 = '0001';

3. 비밀번호 일괄 마이그레이션
-------------------------
> node scripts/migrate-passwords.js

⚠️ DB 백업 필수!
모든 평문 비밀번호를 자동으로 bcrypt 해시로 변환

================================================================================
🔐 보안 체크리스트
================================================================================

설치 후 반드시 확인:
-----------------
☐ .env 파일에 업체별 고유 비밀번호 설정됨
☐ SESSION_SECRET가 랜덤 문자열로 변경됨 (기본값 아님)
☐ .env 파일이 Git에 커밋되지 않음 (.gitignore 확인)
☐ DB 접속 비밀번호가 sa 기본 비밀번호가 아님
☐ 방화벽 설정으로 포트 3000 허용됨
☐ 로그인 테스트 성공

주기적 보안 점검:
--------------
☐ Node.js 보안 업데이트 적용 (npm audit)
☐ 비밀번호 정기 변경 (3~6개월)
☐ 로그 파일 확인 (의심스러운 접근 시도)
☐ DB 백업 정기 실행

================================================================================
❓ 문제 해결 (Troubleshooting)
================================================================================

문제 1: "환경변수가 설정되지 않았습니다" 에러
-------------------------------------------
원인: .env 파일이 없거나 잘못된 위치
해결:
1. 프로젝트 루트 폴더에 .env 파일이 있는지 확인
2. .env.template을 .env로 복사했는지 확인
3. 파일 이름이 정확히 ".env"인지 확인 (.env.txt 아님)

문제 2: SQL Server 연결 실패
-------------------------
원인: DB 설정 오류 또는 SQL Server 실행 안됨
해결:
1. SQL Server가 실행 중인지 확인
2. .env의 DB_SERVER, DB_USER, DB_PASSWORD 확인
3. SQL Server Configuration Manager에서 TCP/IP 활성화 확인
4. 방화벽에서 포트 1433 허용

문제 3: 로그인 안됨 (아이디/비밀번호 오류)
-------------------------------------
원인: 비밀번호 마이그레이션 문제
해결:
1. DB에서 사용자 테이블 확인:
   SELECT 사용자코드, 로그인비밀번호 FROM 사용자;

2. 로그인비밀번호가 짧으면 (4자) → 평문
   로그인비밀번호가 길면 (60자) → 해시

3. 평문/해시 혼재 시: migrate-passwords.js 재실행

문제 4: 포트 3000이 이미 사용 중
-----------------------------
원인: 다른 프로그램이 포트 3000 사용
해결:
1. .env에서 PORT=3001로 변경
2. 서버 재시작

문제 5: npm install 실패
----------------------
원인: 인터넷 연결 문제 또는 npm 버전
해결:
1. 인터넷 연결 확인
2. npm 버전 확인: npm --version
3. npm 업데이트: npm install -g npm
4. 프록시 설정 확인

================================================================================
📞 업체별 설정 정보 기록
================================================================================

아래 정보를 업체별로 기록하여 관리하세요:

업체명: _______________________
설치일: _______________________

서버 정보:
- IP 주소: _______________________
- 포트: 3000
- 관리자: _______________________

데이터베이스:
- DB 서버: _______________________
- DB 이름: YmhDB
- DB 사용자: sa
- DB 비밀번호: (안전한 곳에 별도 보관)

세션 시크릿: (안전한 곳에 별도 보관)

비상 연락처:
- 담당자: _______________________
- 전화번호: _______________________
- 이메일: _______________________

================================================================================
📚 관련 문서
================================================================================

상세 문서 참조:
1. Phase1_작업완료_보고서.txt - 보안 수정 상세 내역
2. 배포전_필수_보안_수정사항.txt - 보안 문제 및 해결 방안
3. CLAUDE.md - 프로젝트 개요 및 기술 문서

================================================================================
