USE [YmhDB]
GO
/****** Object:  StoredProcedure [dbo].[sp자동마감작업갱신]    Script Date: 25-11-16 일요일 오후 3:34:20 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

ALTER PROCEDURE [dbo].[sp자동마감작업갱신] 
      (@ParBranchCode VarChar(02) ='01', @ParDate VarChar(08) = '', @ParMagamGbn TinyInt = 0, 
       @ParKindCode Varchar(02) = '01', @ParMtCode VarChar(20) = '', 
       @ParIOGbn TinyInt = 1, @ParSupplierCode Varchar(08) = '', @ParAccountCode Varchar(04) = '' )

AS

SET @ParMagamGbn = (SELECT 마감구분 = CASE WHEN @ParMagamGbn = 1 AND (SUBSTRING(@ParDate, 1, 6) > T1.자재기초마감년월) THEN 1
                                           WHEN @ParMagamGbn = 2 AND (SUBSTRING(@ParDate, 1, 6) > T1.미지급금기초마감년월) THEN 2
                                           WHEN @ParMagamGbn = 3 AND (SUBSTRING(@ParDate, 1, 6) > T1.미수금기초마감년월)THEN 3  
                                           WHEN @ParMagamGbn = 4 AND (SUBSTRING(@ParDate, 1, 6) > T1.회계기초마감년월)THEN 4
                                      ELSE 0 END
                      FROM 사업장 T1 WHERE T1.사업장코드 = @ParBranchCode )

IF @ParMagamGbn = 1
   BEGIN
     DELETE 자재원장마감 
      WHERE 사업장코드 = @ParBranchCode AND 분류코드 = @ParKindCode AND 세부코드 = @ParMtCode AND 마감년월 = SUBSTRING(@ParDate, 1, 6)

     INSERT 자재원장마감
     SELECT T1.사업장코드, T1.분류코드, T1.세부코드, SUBSTRING(T1.입출고일자, 1, 6), SUM(T1.입고수량), SUM(T1.출고수량), '', ''
       FROM 자재입출내역 T1 
      WHERE T1.사업장코드 = @ParBranchCode AND T1.사용구분 = 0 
        AND SUBSTRING(T1.입출고일자, 1, 6) = SUBSTRING(@ParDate, 1, 6)
        AND T1.분류코드 = @ParKindCode AND T1.세부코드 = @ParMtCode
      GROUP BY T1.사업장코드, T1.분류코드, T1.세부코드, SUBSTRING(T1.입출고일자, 1, 6)

     DELETE 자재원장마감 
      WHERE 사업장코드 = @ParBranchCode AND 분류코드 = @ParKindCode AND 세부코드 = @ParMtCode 
        AND 마감년월 > SUBSTRING(@ParDate, 1, 6) AND SUBSTRING(마감년월, 5, 2) = '00'

     INSERT 자재원장마감 
     SELECT T1.사업장코드, T1.분류코드, T1.세부코드, (CONVERT(VARCHAR(4), (CONVERT(INT, SUBSTRING(T1.마감년월, 1, 4)) + 1)) + '00'),
            SUM(T1.입고누계수량), SUM(T1.출고누계수량), '', ''
       FROM 자재원장마감 T1 
      WHERE T1.사업장코드 = @ParBranchCode AND T1.분류코드 = @ParKindCode AND T1.세부코드 = @ParMtCode 
        AND SUBSTRING(T1.마감년월, 1, 4) >= SUBSTRING(@ParDate, 1, 4)
      GROUP BY T1.사업장코드, T1.분류코드, T1.세부코드, (CONVERT(VARCHAR(4), (CONVERT(INT, SUBSTRING(T1.마감년월, 1, 4)) + 1)) + '00')          

   END
ELSE
IF @ParMagamGbn = 2
   BEGIN
     DELETE 미지급금원장마감 
      WHERE 사업장코드 = @ParBranchCode AND 매입처코드 = @ParSupplierCode AND 마감년월 = SUBSTRING(@ParDate, 1, 6) 

     INSERT INTO 미지급금원장마감
     SELECT T1.사업장코드, T1.매입처코드, SUBSTRING(T1.작성일자, 1, 6), ISNULL(SUM(T1.공급가액 + T1.세액), 0), 0, '', ''                   
       FROM 매입세금계산서장부 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.사용구분 = 0 AND T1.매입처코드 = @ParSupplierCode
        AND T1.미지급구분 = 1 AND SUBSTRING(T1.작성일자, 1, 6) = SUBSTRING(@ParDate, 1, 6)
      GROUP BY T1.사업장코드, T1.매입처코드, SUBSTRING(T1.작성일자, 1, 6)

     UPDATE 미지급금원장마감 SET 미지급금지급누계금액 =
            ISNULL((SELECT SUM(T2.미지급금지급금액) FROM 미지급금내역 T2 
                     WHERE T2.사업장코드 = T1.사업장코드 AND T2.매입처코드 = T1.매입처코드
                       AND SUBSTRING(T2.미지급금지급일자, 1, 6) = T1.마감년월), 0)
       FROM 미지급금원장마감 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.매입처코드 = @ParSupplierCode AND T1.마감년월 = SUBSTRING(@ParDate, 1, 6) 

     INSERT 미지급금원장마감 
     SELECT T1.사업장코드, T1.매입처코드, SUBSTRING(T1.미지급금지급일자, 1, 6), 0, ISNULL(SUM(T1.미지급금지급금액), 0), '', ''
       FROM 미지급금내역 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.매입처코드 = @ParSupplierCode 
        AND SUBSTRING(T1.미지급금지급일자, 1, 6) = SUBSTRING(@ParDate, 1, 6) 
        AND NOT EXISTS 
           (SELECT T2.마감년월
              FROM 미지급금원장마감 T2 
             WHERE T2.사업장코드 = T1.사업장코드 AND T2.매입처코드 = T1.매입처코드 
               AND T2.마감년월 = SUBSTRING(@ParDate, 1, 6))
      GROUP BY T1.사업장코드, T1.매입처코드, SUBSTRING(T1.미지급금지급일자, 1, 6)   

     DELETE 미지급금원장마감 
      WHERE 사업장코드 = @ParBranchCode And 매입처코드 = @ParSupplierCode 
        AND 마감년월 > SUBSTRING(@ParDate, 1, 6) AND SUBSTRING(마감년월, 5, 2) = '00'

     INSERT 미지급금원장마감 
     SELECT T1.사업장코드, T1.매입처코드, (CONVERT(VARCHAR(4), (CONVERT(INT, SUBSTRING(T1.마감년월, 1, 4)) + 1)) + '00'),
            SUM(T1.미지급금누계금액 - T1.미지급금지급누계금액), 0, '', ''
       FROM 미지급금원장마감 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.매입처코드 = @ParSupplierCode
        AND SUBSTRING(T1.마감년월, 1, 4) >= SUBSTRING(@ParDate, 1, 4)
      GROUP BY T1.사업장코드, T1.매입처코드, (CONVERT(VARCHAR(4), (CONVERT(INT, SUBSTRING(T1.마감년월, 1, 4)) + 1)) + '00')

   END 
ELSE
IF @ParMagamGbn = 3
   BEGIN
     DELETE 미수금원장마감 
      WHERE 사업장코드 = @ParBranchCode AND 매출처코드 = @ParSupplierCode AND 마감년월 = SUBSTRING(@ParDate, 1, 6) 

     INSERT INTO 미수금원장마감
     SELECT T1.사업장코드, T1.매출처코드, SUBSTRING(T1.작성일자, 1, 6), ISNULL(SUM(T1.공급가액 + T1.세액), 0), 0, '', ''                   
       FROM 매출세금계산서장부 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.사용구분 = 0 AND T1.매출처코드 = @ParSupplierCode
        AND T1.미수구분 = 1 AND SUBSTRING(T1.작성일자, 1, 6) = SUBSTRING(@ParDate, 1, 6)
      GROUP BY T1.사업장코드, T1.매출처코드, SUBSTRING(T1.작성일자, 1, 6)

     UPDATE 미수금원장마감 SET 미수금입금누계금액 =
            ISNULL((SELECT SUM(T2.미수금입금금액) FROM 미수금내역 T2 
                     WHERE T2.사업장코드 = T1.사업장코드 AND T2.매출처코드 = T1.매출처코드
                       AND SUBSTRING(T2.미수금입금일자, 1, 6) = T1.마감년월), 0)
       FROM 미수금원장마감 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.매출처코드 = @ParSupplierCode AND T1.마감년월 = SUBSTRING(@ParDate, 1, 6) 

     INSERT 미수금원장마감 
     SELECT T1.사업장코드, T1.매출처코드, SUBSTRING(T1.미수금입금일자, 1, 6), 0, ISNULL(SUM(T1.미수금입금금액), 0), '', ''
       FROM 미수금내역 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.매출처코드 = @ParSupplierCode 
        AND SUBSTRING(T1.미수금입금일자, 1, 6) = SUBSTRING(@ParDate, 1, 6) 
        AND NOT EXISTS 
           (SELECT T2.마감년월
              FROM 미수금원장마감 T2 
             WHERE T2.사업장코드 = T1.사업장코드 AND T2.매출처코드 = T1.매출처코드 
               AND T2.마감년월 = SUBSTRING(@ParDate, 1, 6))
      GROUP BY T1.사업장코드, T1.매출처코드, SUBSTRING(T1.미수금입금일자, 1, 6)   

     DELETE 미수금원장마감 
      WHERE 사업장코드 = @ParBranchCode And 매출처코드 = @ParSupplierCode 
        AND 마감년월 > SUBSTRING(@ParDate, 1, 6) AND SUBSTRING(마감년월, 5, 2) = '00'

     INSERT 미수금원장마감 
     SELECT T1.사업장코드, T1.매출처코드, (CONVERT(VARCHAR(4), (CONVERT(INT, SUBSTRING(T1.마감년월, 1, 4)) + 1)) + '00'),
            SUM(T1.미수금누계금액 - T1.미수금입금누계금액), 0, '', ''
       FROM 미수금원장마감 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.매출처코드 = @ParSupplierCode
        AND SUBSTRING(T1.마감년월, 1, 4) >= SUBSTRING(@ParDate, 1, 4)
      GROUP BY T1.사업장코드, T1.매출처코드, (CONVERT(VARCHAR(4), (CONVERT(INT, SUBSTRING(T1.마감년월, 1, 4)) + 1)) + '00')

   END 
ELSE
IF @ParMagamGbn = 4
   BEGIN
     DELETE 회계전표내역마감 
      WHERE 사업장코드 = @ParBranchCode AND 계정코드 = @ParAccountCode AND 마감년월 = SUBSTRING(@ParDate, 1, 6) 

     INSERT 회계전표내역마감 
     SELECT T1.사업장코드, T1.계정코드, SUBSTRING(T1.작성일자, 1, 6), SUM(T1.입금금액), SUM(T1.출금금액), '', ''
       FROM 회계전표내역 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.사용구분 = 0 
        AND SUBSTRING(T1.작성일자, 1, 6) = SUBSTRING(@ParDate, 1, 6)
        AND T1.계정코드 = @ParAccountCode
      GROUP BY T1.사업장코드, T1.계정코드, SUBSTRING(T1.작성일자, 1, 6)

     DELETE 회계전표내역마감 
      WHERE 사업장코드 = @ParBranchCode AND 계정코드 = @ParAccountCode 
        AND 마감년월 > SUBSTRING(@ParDate, 1, 6) AND SUBSTRING(마감년월, 5, 2) = '00'

     INSERT 회계전표내역마감 
     SELECT T1.사업장코드, T1.계정코드, (CONVERT(VARCHAR(4), (CONVERT(INT, SUBSTRING(T1.마감년월, 1, 4)) + 1)) + '00'),
            SUM(T1.입금누계금액), SUM(T1.출금누계금액), '', ''
       FROM 회계전표내역마감 T1
      WHERE T1.사업장코드 = @ParBranchCode AND T1.계정코드 = @ParAccountCode
        AND SUBSTRING(T1.마감년월, 1, 4) >= SUBSTRING(@ParDate, 1, 4)
      GROUP BY T1.사업장코드, T1.계정코드, (CONVERT(VARCHAR(4), (CONVERT(INT, SUBSTRING(T1.마감년월, 1, 4)) + 1)) + '00')

     UPDATE 회계전표내역마감 SET 
            입금누계금액 = CASE WHEN (입금누계금액 > 출금누계금액) THEN (입금누계금액 - 출금누계금액) ELSE 0 END, 
            출금누계금액 = CASE WHEN (입금누계금액 < 출금누계금액) THEN (출금누계금액 - 입금누계금액) ELSE 0 END 
      WHERE 사업장코드 = @ParBranchCode AND 계정코드 = @ParAccountCode
        AND 마감년월 > SUBSTRING(@ParDate, 1, 6) AND SUBSTRING(마감년월, 5, 2) = '00'

   END
 
